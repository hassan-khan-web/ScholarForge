{% extends "layout.html" %}

{% block content %}
<div class="flex-1 flex flex-col h-full overflow-hidden bg-[var(--bg-main)]">
    <!-- Search Header -->
    <div class="h-16 border-b border-[var(--border-color)] flex items-center px-6 bg-[var(--bg-panel)] shrink-0">
        <div class="flex items-center gap-4 flex-1 max-w-3xl mx-auto">
            <svg class="w-5 h-5 text-[var(--text-muted)]" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" autofocus
                class="flex-1 bg-transparent border-none text-[var(--text-main)] text-lg focus:outline-none placeholder:text-[var(--text-muted)]"
                placeholder="Search chats and reports..." oninput="performSearch(this.value)"
                onkeydown="handleSearchKeydown(event)">
            <kbd
                class="text-xs text-[var(--text-muted)] bg-[var(--hover-bg)] px-2 py-1 rounded border border-[var(--border-color)]">ESC
                to go back</kbd>
        </div>
    </div>

    <!-- Search Tabs -->
    <div class="border-b border-[var(--border-color)] bg-[var(--bg-panel)]">
        <div class="flex max-w-3xl mx-auto px-6">
            <button onclick="switchSearchTab('all')" id="search-tab-all"
                class="search-tab px-4 py-3 text-sm font-medium text-[var(--accent-primary)] border-b-2 border-[var(--accent-primary)] transition-colors">
                All Results
            </button>
            <button onclick="switchSearchTab('reports')" id="search-tab-reports"
                class="search-tab px-4 py-3 text-sm font-medium text-[var(--text-muted)] border-b-2 border-transparent hover:text-[var(--text-main)] transition-colors">
                Reports
            </button>
            <button onclick="switchSearchTab('chats')" id="search-tab-chats"
                class="search-tab px-4 py-3 text-sm font-medium text-[var(--text-muted)] border-b-2 border-transparent hover:text-[var(--text-main)] transition-colors">
                Chats
            </button>
        </div>
    </div>

    <!-- Search Results -->
    <div class="flex-1 overflow-y-auto custom-scrollbar">
        <div id="search-results" class="max-w-3xl mx-auto p-6">
            <div class="text-center text-[var(--text-muted)] py-16">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <h2 class="text-xl font-semibold text-[var(--text-main)] mb-2">Search ScholarForge</h2>
                <p class="text-sm">Find your reports and chat sessions quickly</p>
                <p class="text-xs mt-2">Press <kbd
                        class="px-1.5 py-0.5 bg-[var(--hover-bg)] rounded border border-[var(--border-color)]">Ctrl+K</kbd>
                    from anywhere to open search</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let searchData = { reports: [], chats: [] };
    let currentSearchTab = 'all';
    let selectedSearchIndex = -1;
    let filteredResults = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadSearchData);

    // ESC to go back
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            window.history.back();
        }
    });

    async function loadSearchData() {
        try {
            // Show loading state
            const container = document.getElementById('search-results');
            container.innerHTML = `
                <div class="text-center text-[var(--text-muted)] py-16">
                    <div class="animate-pulse">
                        <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-[var(--hover-bg)]"></div>
                        <p class="text-sm">Loading your data...</p>
                    </div>
                </div>`;

            // Load reports
            const reportsRes = await fetch('/api/history');
            const reports = await reportsRes.json();
            searchData.reports = reports.map(r => ({
                id: r.id,
                type: 'report',
                title: r.topic || 'Untitled Report',
                date: r.date
            }));

            // Load report content for search preview (in parallel for better performance)
            const contentPromises = searchData.reports.map(async (r) => {
                try {
                    const contentRes = await fetch(`/api/report/${r.id}`);
                    const content = await contentRes.json();
                    r.preview = content.content ? content.content.substring(0, 150).replace(/[#*_`]/g, '') + '...' : '';
                } catch (e) {
                    r.preview = '';
                }
            });
            await Promise.all(contentPromises);

            // Load chats (sessions from folders)
            const foldersRes = await fetch('/api/folders');
            const folders = await foldersRes.json();
            searchData.chats = [];
            folders.forEach(f => {
                if (f.sessions && f.sessions.length > 0) {
                    f.sessions.forEach(s => {
                        searchData.chats.push({
                            id: s.id,
                            type: 'chat',
                            title: s.title || 'Untitled Chat',
                            folder: f.name,
                            date: s.created_at || null
                        });
                    });
                }
            });

            // Restore default view after loading
            container.innerHTML = `
                <div class="text-center text-[var(--text-muted)] py-16">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <h2 class="text-xl font-semibold text-[var(--text-main)] mb-2">Search ScholarForge</h2>
                    <p class="text-sm">Find your reports and chat sessions quickly</p>
                    <p class="text-xs mt-3 text-[var(--accent-primary)]">
                        ${searchData.reports.length} reports ‚Ä¢ ${searchData.chats.length} chats loaded
                    </p>
                </div>`;

        } catch (err) {
            console.error('Failed to load search data:', err);
            document.getElementById('search-results').innerHTML = `
                <div class="text-center text-red-400 py-16">
                    <p class="text-sm">Failed to load data. Please try refreshing.</p>
                </div>`;
        }
    }

    function performSearch(query) {
        const q = query.trim().toLowerCase();
        let results = [];

        // If query is empty, show all items for the selected tab (except 'all' tab)
        if (!q) {
            if (currentSearchTab === 'reports') {
                results = [...searchData.reports];
            } else if (currentSearchTab === 'chats') {
                results = [...searchData.chats];
            } else {
                // 'all' tab with no query - show empty state
                renderSearchResults([]);
                return;
            }
        } else {
            // Search with query
            // Search reports
            if (currentSearchTab === 'all' || currentSearchTab === 'reports') {
                searchData.reports.forEach(r => {
                    if (r.title.toLowerCase().includes(q) || (r.preview && r.preview.toLowerCase().includes(q))) {
                        results.push(r);
                    }
                });
            }

            // Search chats
            if (currentSearchTab === 'all' || currentSearchTab === 'chats') {
                searchData.chats.forEach(c => {
                    if (c.title.toLowerCase().includes(q) || (c.folder && c.folder.toLowerCase().includes(q))) {
                        results.push(c);
                    }
                });
            }
        }

        filteredResults = results;
        selectedSearchIndex = results.length > 0 ? 0 : -1;
        renderSearchResults(results, !q && currentSearchTab !== 'all');
    }

    function switchSearchTab(tab) {
        currentSearchTab = tab;
        document.querySelectorAll('.search-tab').forEach(t => {
            t.classList.remove('text-[var(--accent-primary)]', 'border-[var(--accent-primary)]');
            t.classList.add('text-[var(--text-muted)]', 'border-transparent');
        });
        const activeTab = document.getElementById(`search-tab-${tab}`);
        activeTab.classList.remove('text-[var(--text-muted)]', 'border-transparent');
        activeTab.classList.add('text-[var(--accent-primary)]', 'border-[var(--accent-primary)]');
        performSearch(document.getElementById('search-input').value);
    }

    function renderSearchResults(results, showAllMode = false) {
        const container = document.getElementById('search-results');

        if (results.length === 0) {
            const query = document.getElementById('search-input').value;
            if (query.trim()) {
                container.innerHTML = `
                    <div class="text-center text-[var(--text-muted)] py-16">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium text-[var(--text-main)]">No results found</p>
                        <p class="text-sm mt-1">Try different keywords or check another tab</p>
                    </div>`;
            } else if (showAllMode) {
                // No items in this category
                const categoryName = currentSearchTab === 'reports' ? 'reports' : 'chat sessions';
                container.innerHTML = `
                    <div class="text-center text-[var(--text-muted)] py-16">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p class="text-lg font-medium text-[var(--text-main)]">No ${categoryName} yet</p>
                        <p class="text-sm mt-1">Your ${categoryName} will appear here</p>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="text-center text-[var(--text-muted)] py-16">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <h2 class="text-xl font-semibold text-[var(--text-main)] mb-2">Search ScholarForge</h2>
                        <p class="text-sm">Find your reports and chat sessions quickly</p>
                    </div>`;
            }
            return;
        }

        // Header text based on mode
        let headerText = `${results.length} result${results.length !== 1 ? 's' : ''} found`;
        if (showAllMode) {
            if (currentSearchTab === 'reports') {
                headerText = `üìÑ All Reports (${results.length})`;
            } else if (currentSearchTab === 'chats') {
                headerText = `üí¨ All Chat Sessions (${results.length})`;
            }
        }

        container.innerHTML = `
            <div class="text-sm font-medium text-[var(--text-main)] mb-4">${headerText}</div>
            <div class="space-y-2">
                ${results.map((r, idx) => `
                    <div class="search-result-item ${idx === selectedSearchIndex ? 'selected' : ''}" 
                         onclick="selectSearchResult(${idx})"
                         data-index="${idx}">
                        <div class="flex items-start gap-4">
                            <div class="mt-1 p-2 rounded-lg bg-[var(--hover-bg)]">
                                ${r.type === 'report' ? `
                                    <svg class="w-5 h-5 text-[var(--accent-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                ` : `
                                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                `}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-medium text-[var(--text-main)]">${r.title}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-[var(--hover-bg)] text-[var(--text-muted)]">
                                        ${r.type === 'report' ? 'Report' : 'Chat'}
                                    </span>
                                </div>
                                ${r.preview ? `<p class="text-sm text-[var(--text-muted)] line-clamp-2">${r.preview}</p>` : ''}
                                ${r.folder ? `<p class="text-xs text-[var(--text-muted)] mt-1">üìÅ ${r.folder}</p>` : ''}
                                ${r.date ? `<p class="text-xs text-[var(--text-muted)] mt-1">${r.date}</p>` : ''}
                            </div>
                            <div class="text-[var(--text-muted)]">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>`;
    }

    function selectSearchResult(index) {
        const result = filteredResults[index];
        if (!result) return;

        if (result.type === 'report') {
            // Navigate to main page and show history with this report
            window.location.href = '/?show_report=' + result.id;
        } else if (result.type === 'chat') {
            // Navigate to the chat session
            window.location.href = `/chat?session_id=${result.id}`;
        }
    }

    function handleSearchKeydown(e) {
        const items = document.querySelectorAll('.search-result-item');
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedSearchIndex = Math.min(selectedSearchIndex + 1, filteredResults.length - 1);
            updateSearchSelection();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedSearchIndex = Math.max(selectedSearchIndex - 1, 0);
            updateSearchSelection();
        } else if (e.key === 'Enter' && selectedSearchIndex >= 0) {
            e.preventDefault();
            selectSearchResult(selectedSearchIndex);
        }
    }

    function updateSearchSelection() {
        document.querySelectorAll('.search-result-item').forEach((item, idx) => {
            item.classList.toggle('selected', idx === selectedSearchIndex);
            if (idx === selectedSearchIndex) {
                item.scrollIntoView({ block: 'nearest' });
            }
        });
    }
</script>
{% endblock %}