{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">
<div class="flex-1 flex flex-col h-full relative w-full">

    <button id="hook-button-fixed" onclick="handleHookButtonClick()"
        class="fixed top-16 right-4 z-50 bg-[var(--accent-primary)] hover:opacity-90 text-white text-xs font-semibold px-4 py-2 rounded-lg shadow-lg border border-[var(--accent-primary)] transition-all transform hover:scale-105 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
        </svg>
        <span>Hook</span>
    </button>

    <div id="welcome-state"
        class="absolute inset-0 z-10 flex flex-col justify-center items-center bg-[var(--bg-main)] transition-opacity duration-300">
        <div
            class="p-8 rounded-2xl bg-[var(--bg-panel)] border border-[var(--border-color)] text-center max-w-sm shadow-2xl">
            <div class="w-14 h-14 bg-blue-500/10 rounded-xl flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-[var(--accent-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 01-2 2h14a2 2 0 01-2 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                    </path>
                </svg>
            </div>
            <h2 class="text-xl font-bold text-[var(--text-main)] mb-2">Research Assistant</h2>
            <p class="text-sm text-[var(--text-muted)] mb-6">Please create a folder to store chat research history.</p>
            <button onclick="window.openFolderModal()"
                class="w-full py-2.5 bg-[var(--accent-primary)] hover:opacity-90 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-blue-500/20">
                Create New Folder
            </button>
        </div>
    </div>

    <div id="chat-interface"
        class="flex-1 flex flex-col h-full hidden opacity-0 transition-opacity duration-300 relative">

        <div
            class="h-14 border-b border-[var(--border-color)] flex items-center justify-between px-6 bg-[var(--bg-panel)]">
            <div class="flex items-center gap-3">
                <span class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)]"></span>
                <span id="active-session-title"
                    class="text-[var(--text-main)] text-sm font-medium tracking-wide">Loading...</span>
            </div>
            <button onclick="attemptNewChat()"
                class="text-xs text-[var(--text-muted)] border border-[var(--border-color)] hover:text-[var(--text-main)] hover:bg-[var(--hover-bg)] px-3 py-1.5 rounded-lg transition-colors">
                + New Chat
            </button>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar p-6 relative chat-fade-mask">
            <div class="max-w-3xl mx-auto space-y-4 pb-24" id="messages-container">
            </div>
        </div>

        <div id="input-container"
            class="absolute inset-0 flex items-center justify-center pointer-events-none transition-all duration-500 ease-out z-20">
            <div id="input-wrapper" class="w-full max-w-3xl px-6 pointer-events-auto">

                <div class="flex items-center gap-3 mb-2 px-1 transition-opacity duration-300" id="chat-settings">
                    <div class="relative group custom-select-container z-40">
                        <input type="hidden" id="model-select" value="default">
                        <button type="button" onclick="toggleCustomSelect('model-select')"
                            class="custom-select-trigger bg-[var(--bg-panel)] border border-[var(--border-color)] text-[var(--text-muted)] text-xs rounded-lg px-3 py-1.5 focus:outline-none focus:border-[var(--accent-primary)] hover:text-[var(--text-main)] transition-colors shadow-sm gap-2">
                            <span id="model-select-trigger-text">nvidia/Nemotron</span>
                            <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="model-select-options" class="custom-select-options min-w-[160px]">
                            <div class="custom-option selected" data-value="default"
                                onclick="selectCustomOption('default', 'nvidia/Nemotron', 'model-select')">
                                <span>nvidia/Nemotron</span>
                            </div>
                            <div class="custom-option" data-value="qwen-80b"
                                onclick="selectCustomOption('qwen-80b', 'Qwen 2.5 72B', 'model-select')">
                                <span>Qwen 2.5 72B</span>
                            </div>
                            <div class="custom-option" data-value="mistral"
                                onclick="selectCustomOption('mistral', 'Mistral Small', 'model-select')">
                                <span>Mistral Small</span>
                            </div>
                            <div class="custom-option" data-value="gemini"
                                onclick="selectCustomOption('gemini', 'Gemini 2.0 Flash', 'model-select')">
                                <span>Gemini 2.0 Flash</span>
                            </div>
                            <div class="custom-option" data-value="gpt-oss"
                                onclick="selectCustomOption('gpt-oss', 'GPT-4o (OSS)', 'model-select')">
                                <span>GPT-4o (OSS)</span>
                            </div>
                            <div class="custom-option" data-value="gemma"
                                onclick="selectCustomOption('gemma', 'Gemma 2 27B', 'model-select')">
                                <span>Gemma 2 27B</span>
                            </div>
                            <div class="custom-option" data-value="deepseek"
                                onclick="selectCustomOption('deepseek', 'DeepSeek R1', 'model-select')">
                                <span>DeepSeek R1</span>
                            </div>
                        </div>
                    </div>

                    <div
                        class="relative flex bg-[var(--bg-panel)] rounded-lg p-0.5 border border-[var(--border-color)] shadow-sm">
                        <!-- Sliding Indicator -->
                        <div id="mode-indicator"
                            class="absolute top-0.5 bottom-0.5 left-0.5 w-[calc(50%-2px)] bg-[var(--accent-primary)] rounded-md transition-all duration-300 ease-in-out shadow-sm">
                        </div>

                        <button onclick="setMode('normal')" id="mode-normal"
                            class="relative z-10 px-3 py-1 rounded-md text-xs font-medium transition-colors text-white">Standard</button>
                        <button onclick="setMode('deep_dive')" id="mode-deep"
                            class="relative z-10 px-3 py-1 rounded-md text-xs font-medium text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">Deep
                            Dive</button>
                    </div>
                </div>

                <div id="file-preview-area" class="flex flex-wrap gap-2 mb-2 px-1 empty:hidden"></div>

                <form id="chat-form" class="relative group">
                    <div
                        class="relative flex items-end gap-2 bg-[var(--bg-sidebar)] border border-[var(--border-color)] rounded-xl shadow-lg transition-all focus-within:border-[var(--accent-primary)] focus-within:ring-1 focus-within:ring-blue-500/20 backdrop-blur-sm bg-opacity-90">

                        <button type="button" onclick="document.getElementById('file-upload').click()"
                            class="p-3 text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors"
                            title="Attach Files">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                </path>
                            </svg>
                        </button>
                        <input type="file" id="file-upload" multiple class="hidden" accept=".pdf,.docx,.txt,.md">

                        <input type="text" id="chat-input"
                            class="w-full bg-transparent border-none text-[var(--text-main)] placeholder-[var(--text-muted)] py-4 focus:ring-0 text-sm"
                            placeholder="Ask a question..." autocomplete="off">

                        <button type="button" id="mic-btn" onclick="toggleRecording()"
                            class="p-3 text-[var(--text-muted)] hover:text-red-500 transition-colors"
                            title="Voice Input">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                                </path>
                            </svg>
                        </button>

                        <button type="submit" id="send-btn"
                            class="p-2 m-2 bg-[var(--accent-primary)] hover:opacity-90 text-white rounded-lg transition-all shadow-md flex-shrink-0">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Configure global variables for external scripts
    window.ADD_HOOK_URL = "{{ url_for('add_hook') }}";
</script>
<script src="{{ url_for('static', path='js/chat.js') }}"></script>
{% endblock %}